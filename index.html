<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Search Terms Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Self-contained, auto-loading Excel dashboard with KPIs, filters, and charts" />

  <!-- SheetJS + Chart.js + FileSaver (CDNs) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#0f1216; --panel:#161b22; --text:#e7ecf3; --muted:#9aa6b2; --accent:#8ab4f8;
      --ok:#36d399; --warn:#fbbf24; --danger:#f87171; --border:#273043; --chip:#212734;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --header-grad: linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,0) 100%);
    }
    body.light{
      --bg:#f7f9fc; --panel:#ffffff; --text:#0f172a; --muted:#475569; --accent:#2563eb;
      --ok:#059669; --warn:#d97706; --danger:#dc2626; --border:#e2e8f0; --chip:#eef2f7;
      --shadow:0 6px 18px rgba(15,23,42,.08);
      --header-grad: linear-gradient(180deg, rgba(15,23,42,.06) 0%, rgba(15,23,42,0) 100%);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";color:var(--text);background:var(--bg)}
    h1,h2,h3{margin:0;font-weight:700;letter-spacing:.3px}
    button{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:transform .05s ease, background .2s ease}
    button:hover{transform:translateY(-1px)} button:disabled{opacity:.5;cursor:not-allowed} button.ghost{background:transparent}
    select.inline,input[type=file]{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}

    .app-header{display:flex;align-items:center;justify-content:space-between;padding:20px clamp(16px,3vw,32px);border-bottom:1px solid var(--border);background:var(--header-grad);position:sticky;top:0;backdrop-filter:blur(6px);z-index:10}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .theme-toggle{display:inline-flex;align-items:center;gap:6px;background:var(--chip)} .theme-toggle .icon{font-size:16px}

    .status{padding:10px clamp(16px,3vw,32px)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:var(--chip);border:1px solid var(--border);border-radius:999px;color:var(--muted)}

    /* Filters */
    .filters{
      display:grid;gap:12px;
      grid-template-columns:repeat(12, minmax(0,1fr));
      padding:10px clamp(16px,3vw,32px) 2px
    }
    .filter{display:grid;gap:6px;min-width:0}
    .filter label{font-weight:600;color:var(--muted);white-space:nowrap}
    .filter select,.filter input[type="search"],.filter input[type="text"]{
      width:100%; background:var(--panel);color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:10px 12px;outline:none;min-width:0; /* prevent overflow */
    }
    .filter.sm{grid-column:span 3}      /* fixed sized boxes */
    .filter.grow{grid-column:span 6}
    .filter.right{align-items:end}
    .filter.date-filter{grid-column:span 6}
    .date-range{display:flex;align-items:center;gap:8px}
    .sep{color:var(--muted)}

    /* KPIs */
    .kpis{padding:8px clamp(16px,3vw,32px);display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .kpi-card{grid-column:span 3;min-height:120px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px}
    .kpi-top{display:flex;align-items:flex-start;justify-content:space-between}
    .kpi-label{color:var(--muted);font-weight:600}
    .kpi-value{font-size:26px;font-weight:800}
    .kpi-sub{color:var(--muted)}
    .kpi-sub-strong{color:var(--ok);font-weight:700}
    .kpi-acos{font-weight:800; font-size:20px; text-align:right} /* bigger than revenue, top-right */

    /* Charts */
    .charts{padding:8px clamp(16px,3vw,32px) 28px;display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .chart-card{position:relative;grid-column:span 4;background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px 18px 14px;box-shadow:var(--shadow);height:380px;max-height:460px;overflow:hidden;display:flex;flex-direction:column}
    .chart-title{font-weight:700;margin-bottom:10px;color:var(--muted)}
    .chart-body{flex:1;min-height:0;position:relative}
    canvas{position:absolute;inset:0;display:block;width:100%;height:100%}
    .nodata{position:absolute;inset:0;display:none;place-items:center;color:var(--muted);font-weight:600;pointer-events:none}

    .app-footer{padding:18px clamp(16px,3vw,32px);border-top:1px solid var(--border);color:var(--muted);text-align:center;background:linear-gradient(0deg,rgba(255,255,255,.03),transparent)}

    @media (max-width:1200px){.kpi-card{grid-column:span 6}.chart-card{grid-column:span 6}}
    @media (max-width:720px){
      .filter.sm,.filter.date-filter,.filter.grow{grid-column:span 12}
      .kpi-card,.chart-card{grid-column:span 12}.chart-card{height:320px}
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div><h1>üîé Search Terms Analytics</h1></div>
    <div class="actions">
      <select id="fileSelect" class="inline" hidden title="Select an Excel file in this repo"></select>
      <button id="pickLocalBtn" class="ghost" title="Open an .xlsx from your computer">Open XLSX</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls" hidden />
      <button id="downloadCsvBtn" class="ghost" disabled title="Download filtered rows as CSV">Download CSV</button>
      <button id="themeToggle" class="theme-toggle" title="Toggle dark/light"><span class="icon">üåô</span><span class="label">Dark</span></button>
    </div>
  </header>

  <section class="status" id="statusArea" aria-live="polite">
    <div class="pill">Loading Excel data‚Ä¶</div>
  </section>

  <!-- Filters -->
  <section class="filters" id="filtersSection" hidden>
    <div class="filter sm"><label for="categoryFilter">Category</label><select id="categoryFilter"><option value="__ALL__">All</option></select></div>
    <div class="filter sm"><label for="brandFilter">Brand</label><select id="brandFilter"><option value="__ALL__">All</option></select></div>
    <div class="filter sm"><label for="loFilter">LO</label><select id="loFilter"><option value="__ALL__">All</option></select></div>
    <div class="filter sm"><label for="ttypeFilter">Targeting Type</label><select id="ttypeFilter"><option value="__ALL__">All</option></select></div>
    <div class="filter sm"><label for="tsubFilter">Targeting SubType</label><select id="tsubFilter"><option value="__ALL__">All</option></select></div>
    <div class="filter sm"><label for="tsub2Filter">Targeting SubType2</label><select id="tsub2Filter"><option value="__ALL__">All</option></select></div>
    <div class="filter sm"><label for="campaignFilter">Campaign Name</label><select id="campaignFilter"><option value="__ALL__">All</option></select></div>
    <div class="filter sm"><label for="portfolioFilter">Portfolio Name</label><select id="portfolioFilter"><option value="__ALL__">All</option></select></div>

    <div class="filter date-filter" id="dateFilterWrap" hidden>
      <label>Date Range</label>
      <div class="date-range">
        <input type="text" id="startDate" placeholder="dd-mm-yyyy" inputmode="numeric" />
        <span class="sep">‚Äî</span>
        <input type="text" id="endDate" placeholder="dd-mm-yyyy" inputmode="numeric" />
      </div>
    </div>

    <div class="filter grow"><label for="searchFilter">Search Term</label><input id="searchFilter" type="search" placeholder="Type to filter terms‚Ä¶"></div>
    <div class="filter right"><button id="clearFiltersBtn" class="ghost" title="Clear filters">Clear Filters</button></div>
  </section>

  <!-- KPIs -->
  <section class="kpis" id="kpiSection" hidden>
    <div class="kpi-card">
      <div class="kpi-top"><div class="kpi-label">Total Searches</div></div>
      <div class="kpi-value" id="kpiTotalSearches">‚Äî</div>
      <div class="kpi-sub" id="kpiTotalImpressions">Impressions: ‚Äî</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-top"><div class="kpi-label">Top Search Term</div></div>
      <div class="kpi-value" id="kpiTopTerm">‚Äî</div>
      <div class="kpi-sub" id="kpiTopTermVolume">Volume: ‚Äî</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-top"><div class="kpi-label">Total Clicks</div></div>
      <div class="kpi-value" id="kpiClicks">‚Äî</div>
      <div class="kpi-sub">Avg CTR (weighted)</div>
      <div class="kpi-sub-strong" id="kpiCTR">‚Äî</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-top">
        <div class="kpi-label">Spend</div>
        <div class="kpi-acos" id="kpiACOS" title="ACOS = Spend / Revenue">‚Äî</div>
      </div>
      <div class="kpi-value" id="kpiSpend">‚Äî</div>
      <div class="kpi-sub">Revenue</div>
      <div class="kpi-sub-strong" id="kpiRevenue">‚Äî</div>
    </div>
  </section>

  <!-- Charts -->
  <section class="charts" id="chartsSection" hidden>
    <div class="chart-card" id="barCard">
      <div class="chart-title">Top 10 Search Terms by Volume</div>
      <div class="chart-body">
        <div class="nodata">No data to display</div>
        <canvas id="barChart"></canvas>
      </div>
    </div>
    <div class="chart-card" id="pieCard">
      <div class="chart-title" id="pieTitle">Breakdown by Category (Spend)</div>
      <div class="chart-body">
        <div class="nodata">No data to display</div>
        <canvas id="pieChart"></canvas>
      </div>
    </div>
    <div class="chart-card" id="lineCard" hidden>
      <div class="chart-title" id="lineTitle">CTR Over Time</div>
      <div class="chart-body">
        <div class="nodata">No data to display</div>
        <canvas id="lineChart"></canvas>
      </div>
    </div>
  </section>

  <footer class="app-footer"><small>Runs fully client-side.</small></footer>

  <script>
  'use strict';

  /* ============================== Globals ============================== */
  const SELECT_ALL="__ALL__";
  const MANIFEST_FILE='excel-index.json';
  const PREFERRED_DEFAULT = 'Products Search Term.xlsx'; // preferred default
  const el={
    status:document.getElementById('statusArea'),
    filters:document.getElementById('filtersSection'),
    kpis:document.getElementById('kpiSection'),
    charts:document.getElementById('chartsSection'),
    fileSelect:document.getElementById('fileSelect'),
    pickLocalBtn:document.getElementById('pickLocalBtn'),
    fileInput:document.getElementById('fileInput'),
    barCard:document.getElementById('barCard'), pieCard:document.getElementById('pieCard'), lineCard:document.getElementById('lineCard'),
    bar:document.getElementById('barChart'), pie:document.getElementById('pieChart'), line:document.getElementById('lineChart'),
    lineTitle:document.getElementById('lineTitle'), pieTitle:document.getElementById('pieTitle'),
    cat:document.getElementById('categoryFilter'), brand:document.getElementById('brandFilter'),
    lo:document.getElementById('loFilter'),
    ttype:document.getElementById('ttypeFilter'),
    tsub:document.getElementById('tsubFilter'),
    tsub2:document.getElementById('tsub2Filter'),
    campaign:document.getElementById('campaignFilter'),
    portfolio:document.getElementById('portfolioFilter'),
    start:document.getElementById('startDate'), end:document.getElementById('endDate'),
    search:document.getElementById('searchFilter'), clear:document.getElementById('clearFiltersBtn'),
    dlCsv:document.getElementById('downloadCsvBtn'),
    themeBtn:document.getElementById('themeToggle'),
    kpi:{
      searches:document.getElementById('kpiTotalSearches'),
      impressions:document.getElementById('kpiTotalImpressions'),
      topTerm:document.getElementById('kpiTopTerm'),
      topVol:document.getElementById('kpiTopTermVolume'),
      clicks:document.getElementById('kpiClicks'),
      ctr:document.getElementById('kpiCTR'),
      spend:document.getElementById('kpiSpend'),
      acos:document.getElementById('kpiACOS'),
      rev:document.getElementById('kpiRevenue')
    }
  };
  const state={ rawHeaders:[], rows:[], columns:{}, present:{category:false,brand:false,date:false,ctr:false}, charts:{bar:null,pie:null,line:null}, fileName:'', availableFiles:[], fileMap:{} };

  const SYN={
    term:["search term","customer search term","term","keyword","search keyword","search query","query"],
    impressions:["impressions","searches","volume","search volume","views"],
    clicks:["clicks","click"],
    ctr:["ctr","click-through rate","click through rate","click thru rate"],
    conv:["conversions","orders","purchases","transactions","sales qty","convs"],
    revenue:["revenue","sales","gmv","turnover","amount","net sales","aov","ordered revenue","attributed sales"],
    spend:["spend","cost","ad spend","ad cost","total spend","ppc spend","cpc cost"],
    category:["category","product category","cat","product type","taxonomy"],
    brand:["brand","maker","manufacturer","brand name"],
    date:["date","day","reporting date","calendar date","dt","order date"],
    lo:["lo","l.o.","line of business","locale","market"],
    targetingType:["targeting type","type"],
    targetingSubType:["targeting subtype","subtype","match type"],
    targetingSubType2:["targeting subtype2","subtype2","match type 2"],
    campaignName:["campaign name","campaign"],
    portfolioName:["portfolio name","portfolio"]
  };
  const SUBSTR={
    term:[/term|keyword|query/i],
    impressions:[/impr|search|volume|views?/i],
    clicks:[/click/i],
    ctr:[/ctr|click.?through/i],
    conv:[/conv|order|purchase|transaction/i],
    revenue:[/rev(enue)?|sales|gmv|turnover|amount/i],
    spend:[/spend|cost\b/i],
    category:[/categor|product type|taxonomy/i],
    brand:[/brand|manufacturer|maker/i],
    date:[/date|day/i],
    lo:[/^(lo|l\.o\.)$|line of business|locale|market/i],
    targetingType:[/targeting.*type|^type$/i],
    targetingSubType:[/subtype|match.*type/i],
    targetingSubType2:[/subtype2|match.*type.*2/i],
    campaignName:[/campaign.*name|^campaign$/i],
    portfolioName:[/portfolio.*name|^portfolio$/i]
  };
  const fmt={
    int:n=>isFinite(n)?n.toLocaleString():"‚Äî",
    compact:n=>isFinite(n)?new Intl.NumberFormat(undefined,{notation:'compact',maximumFractionDigits:1}).format(n):"‚Äî",
    pct:r=>isFinite(r)?(r*100).toLocaleString(undefined,{maximumFractionDigits:2})+'%':"‚Äî",
    money:n=>isFinite(n)?n.toLocaleString(undefined,{style:"currency",currency:"USD"}):"‚Äî"
  };

  const normalizeHeader=h=>String(h||"").trim().toLowerCase().replace(/\s+/g," ");
  const escapeHtml=s=>String(s).replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const debounce=(fn,ms=150)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
  const toDMY=d=>!(d instanceof Date)?"":`${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
  const parseDMY=(s)=>{ if(!s) return null; const m=String(s).match(/^(\d{2})[-/](\d{2})[-/](\d{4})$/); if(!m) return null; const d=new Date(+m[3], +m[2]-1, +m[1]); return isNaN(+d)?null:d; };
  function setStatus(html){ el.status.innerHTML = `<div class="pill">${html}</div>`; }

  document.addEventListener('DOMContentLoaded', async () => {
    initTheme();
    wireButtons();
    await autoLoadExcel();
  });

  function initTheme(){
    const saved=localStorage.getItem('theme')||'dark';
    if(saved==='light') document.body.classList.add('light');
    updateThemeBtn();
    el.themeBtn.addEventListener('click',()=>{
      document.body.classList.toggle('light');
      localStorage.setItem('theme', document.body.classList.contains('light')?'light':'dark');
      updateThemeBtn();
      window._renderAll && window._renderAll();
    });
    function updateThemeBtn(){
      const light=document.body.classList.contains('light');
      el.themeBtn.querySelector('.icon').textContent= light?'‚òÄÔ∏è':'üåô';
      el.themeBtn.querySelector('.label').textContent= light?'Light':'Dark';
    }
  }
  function wireButtons(){
    el.pickLocalBtn.addEventListener('click', ()=> el.fileInput.click());
    el.fileInput.addEventListener('change', handleLocalFile);
    el.dlCsv.addEventListener('click', onDownloadCsv);
  }

  async function autoLoadExcel(){
    try{
      const list = await getExcelList();
      setupFilePicker(list);

      const url = new URL(window.location.href);
      const qFile = url.searchParams.get('file');
      const last  = localStorage.getItem('lastExcelFile');
      const preferred = list.includes(PREFERRED_DEFAULT) ? PREFERRED_DEFAULT : null;

      const pick = preferred
        || qFile
        || (last && list.includes(last) ? last : null)
        || (list[0] || null);

      if(!pick) throw new Error('No Excel files found.');
      await tryLoadSpecific(pick);
    }catch(err){
      console.error(err);
      setStatus('‚ö†Ô∏è No Excel found. Add <code>excel-index.json</code> or click <b>Open XLSX</b>.');
    }
  }

  async function getExcelList(){
    state.availableFiles = [];
    state.fileMap = {};

    // 1) manifest
    try{
      const res = await fetch(MANIFEST_FILE, { cache:'no-store' });
      if(res.ok){
        const manifest = await res.json();
        let items = [];
        if(Array.isArray(manifest)) items = manifest;
        else if(Array.isArray(manifest.files)) items = manifest.files;
        if(items.length){
          for(const it of items){
            if(typeof it === 'string' && /\.xlsx$/i.test(it)){ state.availableFiles.push(it.split('/').pop()); state.fileMap[it.split('/').pop()] = it; }
            else if(it && typeof it === 'object' && /\.xlsx$/i.test(it.name)){ state.availableFiles.push(it.name); state.fileMap[it.name] = it.url || it.name; }
          }
        }
      }
    }catch(_){}

    if(state.availableFiles.length) return state.availableFiles;

    // 2) maybe GH API (public Pages)
    // (omitted here for brevity ‚Äî previous version kept; still works if present)

    // 3) Fallback guesses
    const guesses = [PREFERRED_DEFAULT,'search_data.xlsx','SearchTerms.xlsx','data.xlsx'];
    for(const g of guesses){
      try{ const r = await fetch(g,{method:'HEAD',cache:'no-store'}); if(r.ok){ state.availableFiles.push(g); state.fileMap[g]=g; break; } }catch(_){}
    }
    return state.availableFiles;
  }

  function setupFilePicker(files){
    if(!Array.isArray(files) || !files.length){ el.fileSelect.hidden = true; return; }
    if(files.length < 2){ el.fileSelect.hidden = true; return; }
    el.fileSelect.innerHTML = files.map(f=>`<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join('');
    el.fileSelect.hidden = false;
    el.fileSelect.addEventListener('change', async (e)=>{ const name=e.target.value; if(name) await tryLoadSpecific(name); });
  }

  async function tryLoadSpecific(name){
    const url = state.fileMap[name] || name;
    setStatus(`Loading <code>${escapeHtml(name)}</code> ‚Ä¶`);
    const buf = await (await fetch(url,{cache:'no-store'})).arrayBuffer();
    await tryLoadFromBuffer(buf, name);
  }

  async function handleLocalFile(e){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    setStatus(`Reading local file <code>${escapeHtml(file.name)}</code> ‚Ä¶`);
    const buf = await file.arrayBuffer();
    await tryLoadFromBuffer(buf, file.name);
    e.target.value = '';
  }

  /* =========================== Parse & build rows =========================== */
  async function tryLoadFromBuffer(buf, fileName){
    const wb  = XLSX.read(buf, { type:'array', cellDates:true, cellNF:true, cellText:false });
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];

    const raw  = XLSX.utils.sheet_to_json(ws, { header:1, raw:true,  defval:"" });
    const text = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:"" });
    const aoa  = raw.map((row,r)=> row.map((v,c)=> (v===""||v==null) ? (text[r]?.[c] ?? "") : v));
    if(aoa.length < 2) throw new Error('Sheet is empty or lacks enough rows');

    let headerRowIndex = 1;
    if ((aoa[1]||[]).filter(v=>String(v).trim()!=="").length < 2){
      for(let i=0;i<Math.min(10,aoa.length);i++){
        if ((aoa[i]||[]).filter(v=>String(v).trim()!=="").length >= 2){ headerRowIndex=i; break; }
      }
    }

    const headers = (aoa[headerRowIndex]||[]).map(h => String(h||"").trim());
    state.rawHeaders = headers.slice();
    const dataRows = aoa.slice(headerRowIndex+1);

    const rows=[];
    for(const row of dataRows){
      if(!row || row.every(v=>v==null || String(v).trim()==="")) continue;
      const obj={};
      headers.forEach((h,idx)=>{
        const norm=normalizeHeader(h);
        let val=row[idx];
        const fam=columnFamilySmart(norm);
        if (fam==='date')      val=parseMaybeDate(val);
        else if (['impressions','clicks','ctr','conv','revenue','spend'].includes(fam)) val=parseNumber(val);
        obj[h]=val; obj[norm]=val;
      });
      rows.push(obj);
    }
    state.rows = rows;

    state.columns = {
      term:        findHeaderSmart(headers, SYN.term, SUBSTR.term),
      impressions: findHeaderSmart(headers, SYN.impressions, SUBSTR.impressions),
      clicks:      findHeaderSmart(headers, SYN.clicks, SUBSTR.clicks),
      ctr:         findHeaderSmart(headers, SYN.ctr, SUBSTR.ctr),
      conv:        findHeaderSmart(headers, SYN.conv, SUBSTR.conv),
      revenue:     findHeaderSmart(headers, SYN.revenue, SUBSTR.revenue),
      spend:       findHeaderSmart(headers, SYN.spend, SUBSTR.spend),
      category:    findHeaderSmart(headers, SYN.category, SUBSTR.category),
      brand:       findHeaderSmart(headers, SYN.brand, SUBSTR.brand),
      date:        findHeaderSmart(headers, SYN.date, SUBSTR.date),
      lo:          findHeaderSmart(headers, SYN.lo, SUBSTR.lo),
      targetingType:     findHeaderSmart(headers, SYN.targetingType, SUBSTR.targetingType),
      targetingSubType:  findHeaderSmart(headers, SYN.targetingSubType, SUBSTR.targetingSubType),
      targetingSubType2: findHeaderSmart(headers, SYN.targetingSubType2, SUBSTR.targetingSubType2),
      campaignName:      findHeaderSmart(headers, SYN.campaignName, SUBSTR.campaignName),
      portfolioName:     findHeaderSmart(headers, SYN.portfolioName, SUBSTR.portfolioName),
    };
    state.present = { category: !!state.columns.category, brand: !!state.columns.brand, date: !!state.columns.date, ctr: !!state.columns.ctr };
    state.fileName = String(fileName||'');
    if(state.fileName) localStorage.setItem('lastExcelFile', state.fileName);
    if(!el.fileSelect.hidden && state.fileName && state.availableFiles?.includes?.(state.fileName)){ el.fileSelect.value = state.fileName; }

    initFilters();
    enableUI(true);
    _renderAll();

    setStatus(`Loaded <code>${escapeHtml(state.fileName||'(local file)')}</code> ‚Ä¢ Rows: ${rows.length.toLocaleString()} ‚Ä¢ Sheet: ${escapeHtml(sheetName)}`);
  }

  function parseNumber(v){
    if(v==null) return 0;
    if(typeof v==='number') return isFinite(v)?v:0;
    let s=String(v).trim(); if(!s) return 0;
    if(/^\(.*\)$/.test(s)) s='-'+s.slice(1,-1);
    if(/%$/.test(s)){ const num=parseFloat(s.replace(/[%\s,]/g,'')); return isFinite(num)?num/100:0; }
    s=s.replace(/[$‚Ç¨¬£‚Çπ¬•‚Ç©]|[A-Za-z]/g,'').replace(/,/g,'').trim();
    const num=parseFloat(s); return isFinite(num)?num:0;
  }
  function parseMaybeDate(v){
    if(v==null||v==="") return null;
    if(typeof v==='number'){ const o=XLSX.SSF.parse_date_code(v); if(o&&o.y&&o.m&&o.d) return new Date(o.y,o.m-1,o.d); }
    const d=new Date(v); return isNaN(+d)?null:d;
  }
  function findHeaderSmart(headers, exactList, substrRx){
    const L=headers.map(normalizeHeader);
    for(const k of exactList){ const idx=L.indexOf(k); if(idx!==-1) return {idx, name:headers[idx]}; }
    for(let i=0;i<L.length;i++){ if(substrRx.some(rx=>rx.test(L[i]))) return {idx:i, name:headers[i]}; }
    return null;
  }
  function columnFamilySmart(norm){
    const has=(arr,rx)=> (arr?.includes(norm) || rx?.some(r=>r.test(norm)));
    if (has(SYN.term,SUBSTR.term)) return 'term';
    if (has(SYN.impressions,SUBSTR.impressions)) return 'impressions';
    if (has(SYN.clicks,SUBSTR.clicks)) return 'clicks';
    if (has(SYN.ctr,SUBSTR.ctr)) return 'ctr';
    if (has(SYN.conv,SUBSTR.conv)) return 'conv';
    if (has(SYN.revenue,SUBSTR.revenue)) return 'revenue';
    if (has(SYN.spend,SUBSTR.spend)) return 'spend';
    if (has(SYN.category,SUBSTR.category)) return 'category';
    if (has(SYN.brand,SUBSTR.brand)) return 'brand';
    if (has(SYN.date,SUBSTR.date)) return 'date';
    if (has(SYN.lo,SUBSTR.lo)) return 'lo';
    if (has(SYN.targetingType,SUBSTR.targetingType)) return 'targetingType';
    if (has(SYN.targetingSubType,SUBSTR.targetingSubType)) return 'targetingSubType';
    if (has(SYN.targetingSubType2,SUBSTR.targetingSubType2)) return 'targetingSubType2';
    if (has(SYN.campaignName,SUBSTR.campaignName)) return 'campaignName';
    if (has(SYN.portfolioName,SUBSTR.portfolioName)) return 'portfolioName';
    return 'other';
  }

  /* ============================== Filters ============================== */
  const FILTERS = []; // will populate after init with {el, key}
  function initFilters(){
    buildSelect(el.cat,       uniqValues('category'));
    buildSelect(el.brand,     uniqValues('brand'));
    buildSelect(el.lo,        uniqValues('lo'));
    buildSelect(el.ttype,     uniqValues('targetingType'));
    buildSelect(el.tsub,      uniqValues('targetingSubType'));
    buildSelect(el.tsub2,     uniqValues('targetingSubType2'));
    buildSelect(el.campaign,  uniqValues('campaignName'));
    buildSelect(el.portfolio, uniqValues('portfolioName'));

    // register filters for cascading updates
    FILTERS.length = 0;
    [
      {el:el.cat, key:'category'},
      {el:el.brand, key:'brand'},
      {el:el.lo, key:'lo'},
      {el:el.ttype, key:'targetingType'},
      {el:el.tsub, key:'targetingSubType'},
      {el:el.tsub2, key:'targetingSubType2'},
      {el:el.campaign, key:'campaignName'},
      {el:el.portfolio, key:'portfolioName'},
    ].forEach(f=>{ if(f.el && state.columns[f.key]) FILTERS.push(f); });

    if (state.present.date){
      const dkey = normalizeHeader(state.columns.date.name);
      const dates = state.rows.map(r => r[dkey]).filter(Boolean).sort((a,b)=>a-b);
      el.start.value = dates[0] ? toDMY(dates[0]) : '';
      el.end.value   = dates[dates.length-1] ? toDMY(dates[dates.length-1]) : '';
      document.getElementById('dateFilterWrap').hidden = false;
    } else {
      document.getElementById('dateFilterWrap').hidden = true;
      el.start.value = ''; el.end.value = '';
    }

    // cascading: when a filter changes, update others based on context
    FILTERS.forEach(({el:sel}) => sel.addEventListener('change', ()=>{
      updateAllFilterOptions(sel);
      _renderAll();
    }));

    [el.start, el.end].forEach(n => n.addEventListener('input', debounce(()=>{
      const fix=v=>{const d=parseDMY(v); return d?toDMY(d):v;};
      n.value=fix(n.value); updateAllFilterOptions(null); _renderAll();
    },200)));

    el.search.addEventListener('input', debounce(_renderAll, 200));

    el.clear.addEventListener('click', e => {
      e.preventDefault();
      FILTERS.forEach(({el:sel})=> sel.value=SELECT_ALL);
      if (state.present.date){
        const dkey = normalizeHeader(state.columns.date.name);
        const dates = state.rows.map(r => r[dkey]).filter(Boolean).sort((a,b)=>a-b);
        el.start.value = dates[0] ? toDMY(dates[0]) : '';
        el.end.value   = dates[dates.length-1] ? toDMY(dates[dates.length-1]) : '';
      } else { el.start.value=''; el.end.value=''; }
      el.search.value = '';
      updateAllFilterOptions(null);
      _renderAll();
    });

    // initial cascade to ensure lists are consistent
    updateAllFilterOptions(null);
  }

  function uniqValues(kind){
    const col = state.columns[kind];
    if(!col) return [];
    const key = normalizeHeader(col.name);
    const set = new Set();
    state.rows.forEach(r => { const v = r[key]; if (v==null || v==="") return; set.add(String(v)); });
    return Array.from(set).sort((a,b)=> String(a).localeCompare(String(b)));
  }
  function uniqValuesFromRows(kind, rows){
    const col = state.columns[kind];
    if(!col) return [];
    const key = normalizeHeader(col.name);
    const set = new Set();
    rows.forEach(r => { const v = r[key]; if (v==null || v==="") return; set.add(String(v)); });
    return Array.from(set).sort((a,b)=> String(a).localeCompare(String(b)));
  }
  function buildSelect(sel, options){
    sel.innerHTML = `<option value="${SELECT_ALL}">All</option>` + options.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
  }

  // rows constrained by all current filters EXCEPT the one being edited; date applies, search does NOT affect lists
  function rowsForFilterContext(excludeSel){
    const key = name => state.columns[name] ? normalizeHeader(state.columns[name].name) : null;
    const dateKey  = key('date');
    const from = dateKey && parseDMY(el.start.value);
    const to   = dateKey && parseDMY(el.end.value); if(to) to.setHours(23,59,59,999);

    const choice = (sel)=> sel && sel.value !== SELECT_ALL ? sel.value : null;

    const active = {};
    FILTERS.forEach(({el:sel, key:k})=>{
      if(excludeSel && sel===excludeSel) return;
      const colKey = key(k);
      const val = choice(sel);
      if(colKey && val != null) active[colKey] = val;
    });

    return state.rows.filter(r=>{
      if(dateKey && (from||to)){
        const d=r[dateKey]; if(!(d instanceof Date)) return false;
        if (from && d<from) return false; if (to && d>to) return false;
      }
      for(const colKey in active){ if(String(r[colKey]) !== active[colKey]) return false; }
      return true;
    });
  }

  // refresh options for every filter (preserving current selections where possible)
  function updateAllFilterOptions(excludeSel){
    const baseRows = rowsForFilterContext(excludeSel || null);
    FILTERS.forEach(({el:sel, key:k})=>{
      const prev = sel.value;
      const options = uniqValuesFromRows(k, baseRows);
      buildSelect(sel, options);
      // restore selection if still available
      if(options.includes(prev)) sel.value = prev;
      else sel.value = SELECT_ALL;
    });
  }

  function getFilteredRows(){
    const key = name => state.columns[name] ? normalizeHeader(state.columns[name].name) : null;
    const termKey  = key('term'), catKey=key('category'), brandKey=key('brand'), dateKey=key('date');
    const loKey=key('lo'), ttypeKey=key('targetingType'), tsubKey=key('targetingSubType'), tsub2Key=key('targetingSubType2'), campKey=key('campaignName'), portKey=key('portfolioName');

    const needle = el.search.value.trim().toLowerCase();
    const from = dateKey && parseDMY(el.start.value);
    const to   = dateKey && parseDMY(el.end.value); if(to) to.setHours(23,59,59,999);

    return state.rows.filter(r=>{
      if (needle && termKey){ const t=(r[termKey]??'').toString().toLowerCase(); if(!t.includes(needle)) return false; }
      if (catKey   && el.cat.value  !== SELECT_ALL && String(r[catKey])   !== el.cat.value)   return false;
      if (brandKey && el.brand.value!== SELECT_ALL && String(r[brandKey]) !== el.brand.value) return false;
      if (loKey    && el.lo.value   !== SELECT_ALL && String(r[loKey])    !== el.lo.value)    return false;
      if (ttypeKey && el.ttype.value!== SELECT_ALL && String(r[ttypeKey]) !== el.ttype.value) return false;
      if (tsubKey  && el.tsub.value !== SELECT_ALL && String(r[tsubKey])  !== el.tsub.value)  return false;
      if (tsub2Key && el.tsub2.value!== SELECT_ALL && String(r[tsub2Key]) !== el.tsub2.value) return false;
      if (campKey  && el.campaign.value!== SELECT_ALL && String(r[campKey]) !== el.campaign.value) return false;
      if (portKey  && el.portfolio.value!== SELECT_ALL && String(r[portKey]) !== el.portfolio.value) return false;
      if (dateKey && (from||to)){
        const d=r[dateKey]; if(!(d instanceof Date)) return false;
        if (from && d<from) return false; if (to && d>to) return false;
      }
      return true;
    });
  }

  /* ================================ KPIs ============================== */
  function computeKPIs(rows){
    const k={
      term: state.columns.term ? normalizeHeader(state.columns.term.name) : null,
      imp:  state.columns.impressions ? normalizeHeader(state.columns.impressions.name) : null,
      clk:  state.columns.clicks ? normalizeHeader(state.columns.clicks.name) : null,
      ctr:  state.columns.ctr ? normalizeHeader(state.columns.ctr.name) : null,
      rev:  state.columns.revenue ? normalizeHeader(state.columns.revenue.name) : null,
      spend:state.columns.spend ? normalizeHeader(state.columns.spend.name) : null
    };
    let impT=0, clkT=0, revT=0, spendT=0;
    const volKey = k.imp || k.clk;
    let topTerm=null, topVol=-Infinity;
    for(const r of rows){
      const imp=+r[k.imp]||0, clk=+r[k.clk]||0, rev=+r[k.rev]||0, sp=+r[k.spend]||0;
      const vol=volKey?(+r[volKey]||0):0; const term=k.term ? r[k.term] : '(unknown)';
      impT+=imp; clkT+=clk; revT+=rev; spendT+=sp;
      if (vol>topVol){ topVol=vol; topTerm=term; }
    }
    const avgCTR = impT>0 ? clkT/impT : 0;
    const acos = revT>0 ? (spendT/revT) : NaN;
    return { totalImpressions:impT, totalClicks:clkT, totalRevenue:revT, totalSpend:spendT, avgCTR, topTerm:topTerm??'‚Äî', topTermVolume:isFinite(topVol)?topVol:0, acos };
  }
  function renderKPIs(x){
    el.kpi.searches.textContent = fmt.int(x.totalImpressions);
    el.kpi.impressions.textContent = 'Impressions: ' + fmt.int(x.totalImpressions);
    el.kpi.topTerm.textContent = x.topTerm || '‚Äî';
    el.kpi.topVol.textContent = 'Volume: ' + fmt.int(x.topTermVolume);
    el.kpi.clicks.textContent = fmt.int(x.totalClicks);
    el.kpi.ctr.textContent = fmt.pct(x.avgCTR);
    el.kpi.spend.textContent = fmt.money(x.totalSpend);
    el.kpi.rev.textContent = fmt.money(x.totalRevenue);
    el.kpi.acos.textContent = isFinite(x.acos) ? (x.acos*100).toFixed(1)+'% ACOS' : '‚Äî';
  }

  /* ================================ Charts ================================ */
  function setNoData(cardEl, hasData){
    const nd=cardEl.querySelector('.nodata'); if(!nd) return;
    nd.style.display = hasData ? 'none':'grid';
    nd.hidden = hasData;
  }
  function chartColors(n){ const light=document.body.classList.contains('light'); const L=light?55:65; return Array.from({length:n},(_,i)=>`hsl(${Math.round((360/n)*i)},70%,${L}%)`); }
  function pureColors(n){ const base=['#E74C3C','#3498DB','#2ECC71','#F1C40F','#9B59B6','#E67E22','#1ABC9C','#E91E63','#34495E','#95A5A6','#D35400','#27AE60']; return Array.from({length:n},(_,i)=> base[i % base.length]); }
  function cssVar(name){ return getComputedStyle(document.body).getPropertyValue(name).trim(); }

  /* Plugin: show arc labels (category names) on doughnut */
  const arcLabelPlugin = {
    id:'arcLabel',
    afterDatasetsDraw(chart){
      const {ctx} = chart;
      const ds = chart.data.datasets[0]; if(!ds) return;
      const meta = chart.getDatasetMeta(0);
      const data = ds.data || [];
      const labels = chart.data.labels || [];
      const total = data.reduce((a,b)=>a+(+b||0),0) || 1;
      ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
      for(let i=0;i<meta.data.length;i++){
        const el = meta.data[i]; if(!el) continue;
        const v = +data[i]||0; const pct=v/total;
        if(pct < 0.04) continue; // skip tiny slices
        const p = el.getProps(['startAngle','endAngle','innerRadius','outerRadius','x','y'], true);
        const a = (p.startAngle + p.endAngle)/2;
        const r = (p.innerRadius + p.outerRadius)/2;
        const x = p.x + Math.cos(a)*r;
        const y = p.y + Math.sin(a)*r;
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text').trim() || '#fff';
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
        ctx.fillText(String(labels[i] ?? '').slice(0,16), x, y);
      }
      ctx.restore();
    }
  };

  /* Plugin: draw value labels at end of bars (compact) */
  const barValueLabels = {
    id:'barValueLabels',
    afterDatasetsDraw(chart){
      if(chart.config.type!=='bar') return;
      const meta = chart.getDatasetMeta(0);
      const ds = chart.data.datasets[0]; if(!ds) return;
      const {ctx, chartArea:{right}} = chart;
      ctx.save();
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text').trim() || '#fff';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      meta.data.forEach((bar, i)=>{
        const val = ds.data[i]; if(val==null) return;
        const p = bar.getProps(['x','y'], true);
        const text = fmt.compact(+val);
        const x = Math.min(p.x + 8, right - 2);
        ctx.textAlign='left'; ctx.textBaseline='middle';
        ctx.fillText(text, x, p.y);
      });
      ctx.restore();
    }
  };

  Chart.register(arcLabelPlugin, barValueLabels);

  function renderBar(rows){
    const k={ term: state.columns.term ? normalizeHeader(state.columns.term.name) : null,
              imp: state.columns.impressions ? normalizeHeader(state.columns.impressions.name) : null,
              clk: state.columns.clicks ? normalizeHeader(state.columns.clicks.name) : null };
    const volKey = k.imp || k.clk;
    const map=new Map();
    for(const r of rows){ const t = k.term ? String(r[k.term]) : '(unknown)'; const v = volKey ? (+r[volKey]||0) : 0; map.set(t, (map.get(t)||0)+v); }
    const pairs = [...map.entries()].filter(p=>p[1]>0).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const labels = pairs.map(p=>p[0]); const data = pairs.map(p=>p[1]);
    const hasData = labels.length>0 && data.some(v=>v>0);
    setNoData(el.barCard, hasData);
    if(state.charts.bar) state.charts.bar.destroy();
    const dsColor = chartColors(1)[0];
    state.charts.bar = new Chart(el.bar.getContext('2d'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Volume', data, borderWidth:0, backgroundColor: dsColor }] },
      options:{
        indexAxis:'y', responsive:true, maintainAspectRatio:false, layout:{ padding:8 },
        interaction:{ mode:'nearest', axis:'y', intersect:false }, /* hover anywhere along Y band */
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:ctx=>' '+fmt.int(ctx.parsed.x) } } },
        scales:{
          x:{ beginAtZero:true, grid:{ display:false }, ticks:{ callback:(v)=>fmt.compact(v) } },
          y:{ ticks:{ autoSkip:false }, grid:{ display:true, lineWidth:0.3 } }
        }
      }
    });
  }

  function renderPie(rows){
    const byCat=!!state.columns.category, byBrand=!!state.columns.brand;
    const spendKey = state.columns.spend ? normalizeHeader(state.columns.spend.name) : null;

    let keyName=null;
    if(byCat){ keyName=normalizeHeader(state.columns.category.name); el.pieTitle.textContent='Breakdown by Category (Spend)'; }
    else if(byBrand){ keyName=normalizeHeader(state.columns.brand.name); el.pieTitle.textContent='Breakdown by Brand (Spend)'; }
    else{ el.pieTitle.textContent='Breakdown by Top Terms (Spend)'; keyName = state.columns.term ? normalizeHeader(state.columns.term.name) : null; }

    const map=new Map();
    for(const r of rows){
      const key=String(r[keyName] ?? '(Unspecified)');
      const v=spendKey?(+r[spendKey]||0):0;
      map.set(key,(map.get(key)||0)+v);
    }

    let pairs=[...map.entries()].filter(p=>p[1]>0).sort((a,b)=>b[1]-a[1]);
    const MAX_SLICES=10; if(pairs.length>MAX_SLICES){ const top=pairs.slice(0,MAX_SLICES); const other=pairs.slice(MAX_SLICES).reduce((s,p)=>s+p[1],0); if(other>0) pairs=[...top,['Other',other]]; else pairs=top; }
    const labels=pairs.map(p=>p[0]); const data=pairs.map(p=>p[1]);
    const hasData = labels.length>0 && data.some(v=>v>0);
    setNoData(el.pieCard, hasData);
    if(state.charts.pie) state.charts.pie.destroy();

    state.charts.pie = new Chart(el.pie.getContext('2d'), {
      type:'doughnut',
      data:{ labels, datasets:[{
        data,
        backgroundColor:pureColors(labels.length),
        borderColor: cssVar('--panel') || (document.body.classList.contains('light')?'#fff':'#161b22'),
        borderWidth:2, hoverOffset:6, cutout:'45%'
      }] },
      options:{
        responsive:true, maintainAspectRatio:false, layout:{ padding:8 },
        plugins:{
          legend:{ display:true, position:'right', labels:{ usePointStyle:true, boxWidth:10, boxHeight:10, padding:10, font:{ size:11 } } },
          tooltip:{ enabled:true, callbacks:{
            title:(ctx)=> ctx[0]?.label ?? '',
            label:(ctx)=>{ const val=ctx.parsed; const ds=ctx.dataset?.data||[]; const tot=ds.reduce((a,b)=>a+(+b||0),0); const pct=tot? (val/tot*100):0; return ` ${fmt.money(val)} (${pct.toFixed(1)}%)`; }
          } }
        }
      }
    });
  }

  function renderLine(rows){
    if(!state.columns.date){ el.lineCard.hidden=true; if(state.charts.line){ state.charts.line.destroy(); state.charts.line=null; } return; }
    el.lineCard.hidden=false;
    const dateKey=normalizeHeader(state.columns.date.name);
    const impKey = state.columns.impressions ? normalizeHeader(state.columns.impressions.name) : null;
    const clkKey = state.columns.clicks ? normalizeHeader(state.columns.clicks.name) : null;
    const ctrKey = state.columns.ctr ? normalizeHeader(state.columns.ctr.name) : null;

    const map=new Map();
    for(const r of rows){
      const d=r[dateKey]; const iso = d instanceof Date ? toDMY(d) : ''; if(!iso) continue;
      const imp=impKey?(+r[impKey]||0):0;
      const clk = clkKey?(+r[clkKey]||0) : (ctrKey && impKey ? (+r[ctrKey])*imp : 0);
      const prev=map.get(iso)||{imp:0,clk:0}; prev.imp+=imp; prev.clk+=clk; map.set(iso,prev);
    }
    const series=[...map.entries()].sort((a,b)=>{ const p=a[0].split('-').reverse().join(''); const q=b[0].split('-').reverse().join(''); return p.localeCompare(q); });
    const labels=series.map(s=>s[0]);
    const ctrData=series.map(s => s[1].imp>0 ? s[1].clk/s[1].imp : 0);

    const hasData = labels.length>0; setNoData(el.lineCard, hasData);
    if(state.charts.line) state.charts.line.destroy();

    const months = labels.map(l => l.slice(3)); // mm-yyyy
    const uniq=[]; const monthIndex = months.map(m=>{ let i=uniq.indexOf(m); if(i===-1){ i=uniq.push(m)-1; } return i; });
    const pal = chartColors(8); const colorFor = i=> pal[i % pal.length];
    const pointColors = monthIndex.map(i=>colorFor(i));

    state.charts.line = new Chart(el.line.getContext('2d'), {
      type:'line',
      data:{ labels, datasets:[{
        label:'CTR', data:ctrData, fill:false, tension:.2,
        pointRadius:2, pointHoverRadius:3, pointBackgroundColor: pointColors, pointBorderColor: pointColors, borderWidth:2,
        segment:{ borderColor: ctx => colorFor(monthIndex[ctx.p1DataIndex]||0) }
      }] },
      options:{
        responsive:true, maintainAspectRatio:false, layout:{ padding:8 },
        interaction:{ mode:'index', axis:'x', intersect:false },
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{
          title:(items)=> items.length? items[0].label : '',
          label:x=>' '+(x.parsed.y*100).toFixed(2)+'%'
        } } },
        scales:{ x:{ ticks:{ display:false }, grid:{ display:false } }, y:{ ticks:{ callback:v=>(v*100).toFixed(0)+'%' }, suggestedMin:0 } }
      }
    });
  }

  function enableUI(ready){ el.filters.hidden=!ready; el.kpis.hidden=!ready; el.charts.hidden=!ready; el.dlCsv.disabled=!ready; }
  function _renderAll(){ const filtered = getFilteredRows(); const k = computeKPIs(filtered); renderKPIs(k); renderBar(filtered); renderPie(filtered); renderLine(filtered); }
  window._renderAll=_renderAll;

  function onDownloadCsv(){
    const rows = getFilteredRows();
    if (!rows.length){ alert('No rows to download for current filters.'); return; }
    const headers = state.rawHeaders.slice();
    const out = rows.map(r=>{ const o={}; headers.forEach(h=>o[h]=r[h]); return o; });
    const csv = toCSV(headers, out);
    const base = state.fileName? state.fileName.replace(/\.[^.]+$/,'') : 'search_data';
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    saveAs(blob, base+'-filtered.csv');
  }
  function toCSV(headers, rows){
    const esc=v=>{ if(v==null) return ''; const s=String(v); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; };
    const head=headers.map(esc).join(',')+'\n';
    const body=rows.map(r=>headers.map(h=>esc(r[h])).join(',')).join('\n');
    return head+body;
  }
  </script>
</body>
</html>
