<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Search Terms Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Self-contained, auto-loading Excel dashboard with KPIs, filters, and charts" />

  <!-- SheetJS + Chart.js + FileSaver (CDNs) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#0f1216; --panel:#161b22; --text:#e7ecf3; --muted:#9aa6b2; --accent:#2563eb;
      --ok:#36d399; --warn:#fbbf24; --danger:#f87171; --border:#273043; --chip:#212734;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --header-grad: linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,0) 100%);
      --ink:#0f172a; --blue:#2563eb;
    }
    body.light{
      --bg:#f7f9fc; --panel:#ffffff; --text:#0f172a; --muted:#475569; --accent:#2563eb;
      --ok:#059669; --warn:#d97706; --danger:#dc2626; --border:#e2e8f0; --chip:#eef2f7;
      --shadow:0 6px 18px rgba(15,23,42,.08);
      --header-grad: linear-gradient(180deg, rgba(15,23,42,.06) 0%, rgba(15,23,42,0) 100%);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";color:var(--text);background:var(--bg)}
    h1,h2,h3{margin:0;font-weight:700;letter-spacing:.3px}

    /* Hide header while loading */
    .loading .app-header{display:none;}

    button{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:transform .12s ease, box-shadow .25s ease, background .2s ease, border-color .2s ease}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    button:disabled{opacity:.5;cursor:not-allowed}
    button.ghost{background:transparent}
    .btn-primary{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg, var(--accent), color-mix(in srgb, var(--accent) 85%, #000));color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(37,99,235,.25)}
    .btn-outline{display:inline-flex;align-items:center;gap:8px;background:transparent;border-color:var(--accent);color:var(--accent)}
    .btn-mode{ display:inline-flex;align-items:center;gap:8px;border-radius:14px;padding:10px 14px;border:1px solid transparent;font-weight:700 }
    .btn-mode.mode-dark{ background:#0f172a; color:#ffffff; border-color:#0f172a }
    .btn-mode.mode-light{ background:#eaeef5; color:#0f172a; border-color:#cbd5e1 }

    .app-header{display:flex;align-items:center;justify-content:space-between;padding:20px clamp(16px,3vw,32px);border-bottom:1px solid var(--border);background:var(--header-grad);position:sticky;top:0;backdrop-filter:blur(6px);z-index:20}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* Full-screen loading overlay */
    #statusArea{display:none}
    #statusArea.show{position:fixed; inset:0; z-index:1000; display:grid; place-items:center; background:radial-gradient(900px 400px at 20% -10%, color-mix(in srgb, #ffffff 4%, var(--bg)) 0%, var(--bg) 45%)}
    .loader{display:flex;align-items:center;gap:14px;padding:16px 18px;border:1px dashed var(--border);border-radius:14px;background:var(--chip);box-shadow:var(--shadow)}
    .spinner{width:22px;height:22px;border-radius:50%;border:3px solid rgba(255,255,255,.25);border-top-color:var(--accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .dots:after{content:"";animation:ellipsis 1.2s infinite steps(4,end)}
    @keyframes ellipsis{0%{content:""}25%{content:"."}50%{content:".."}75%{content:"..."}100%{content:""}}

    /* KPI Cards */
    .kpis{padding:8px clamp(16px,3vw,32px);display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .kpi-card{ grid-column:span 3;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column }
    .kpi-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:2px}
    .kpi-label{color:var(--muted);font-weight:600}
    .kpi-value{font-size:26px;font-weight:800;line-height:1.1;margin-top:2px}
    /* 5px gap from big number to next header */
    .kpi-value + .kpi-sub{margin-top:5px}
    .kpi-sub{color:var(--muted)}
    .kpi-sub-strong{color:#1e40af;font-weight:800}
    .kpi-right{text-align:right;line-height:1}
    .kpi-acos-label,.kpi-ctr-label{font-size:12px;color:var(--muted);margin-bottom:2px}
    .kpi-acos-val,.kpi-ctr-val{font-size:18px;color:var(--ok);font-weight:800;display:block;margin-top:2px}
    #kpiImpressionsBlack{ color:#000; font-weight:800 }

    /* Charts */
    .charts{padding:8px clamp(16px,3vw,32px) 28px;display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .chart-card{position:relative;grid-column:span 4;background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px 18px 14px;box-shadow:var(--shadow);height:380px;max-height:460px;overflow:hidden;display:flex;flex-direction:column}
    .chart-title{font-weight:700;margin-bottom:10px;color:var(--muted)}
    .chart-body{flex:1;min-height:0;position:relative}
    canvas{position:absolute;inset:0;display:block;width:100%;height:100%}
    .nodata{position:absolute;inset:0;display:none;place-items:center;color:var(--muted);font-weight:600;pointer-events:none}

    /* Modal (filters) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.open{display:flex}
    .modal-card{width:min(1100px,94vw);max-height:86vh;overflow-y:auto;overflow-x:hidden;background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:20px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

    .filters{display:grid;gap:14px;grid-template-columns:repeat(12, minmax(0,1fr))}
    .filter{display:grid;gap:6px;min-width:0}
    .filter label{font-weight:600;color:var(--muted);white-space:nowrap}

    /* Filter dropdown chip */
    .dd{position:relative}
    .dd-control{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel);cursor:pointer;min-height:40px}
    .dd-summary{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dd-chev{opacity:.8}

    /* Dropdown panel with modal-aware left flip */
    .dd-panel{position:absolute;top:calc(100% + 8px);left:0;z-index:100;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);width:min(420px, 90vw);max-width:calc(100vw - 48px);display:none}
    .dd.open .dd-panel{display:block}
    .dd.align-right .dd-panel{right:0; left:auto}

    .dd-head{display:grid;grid-template-columns: 1fr 1.4fr 100px;gap:6px;align-items:center;padding:8px;border-bottom:1px solid var(--border);background:var(--chip);border-top-left-radius:12px;border-top-right-radius:12px}
    .dd-head .select-all{display:flex;align-items:center;gap:8px;font-weight:700}
    .dd-head input[type="search"]{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:var(--panel);color:var(--text)}
    .dd-head .rc{justify-self:end;color:var(--muted);font-weight:700}
    .dd-list{max-height:360px;overflow:auto;padding:6px}
    .dd-item{display:grid;grid-template-columns:1fr auto 60px;gap:8px;align-items:center;padding:6px;border-radius:8px}
    .dd-item:hover{background:var(--chip)}
    .dd-left{display:flex;align-items:center;gap:8px;min-width:0}
    .dd-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:30ch}
    .dd-only{border:1px solid var(--border);background:var(--chip);color:var(--muted);border-radius:8px;padding:4px 8px;cursor:pointer}
    .dd-count{text-align:right;color:var(--muted);font-variant-numeric:tabular-nums}

    .filter{grid-column:span 4}
    .filter.grow{grid-column:span 8}
    .filter.date{grid-column:span 6}
    .filter.search{grid-column:span 12}

    @media (max-width:1200px){.kpi-card{grid-column:span 6}.chart-card{grid-column:span 6}}
    @media (max-width:720px){
      .kpi-card,.chart-card{grid-column:span 12}.chart-card{height:320px}
      .filter{grid-column:span 12}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div><h1>ðŸ”Ž Search Terms Analytics</h1></div>
    <div class="actions">
      <button id="openFilters" class="btn-outline" title="Show filters" style="display:none">Filters</button>
      <select id="fileSelect" class="inline" hidden title="Select an Excel file in this repo"></select>
      <button id="pickLocalBtn" class="btn-primary" title="Open an .xlsx from your computer">Open XLSX</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls" hidden />
      <button id="downloadCsvBtn" class="btn-primary" disabled title="Download filtered rows as CSV">Download CSV</button>
      <button id="themeToggle" class="btn-mode mode-light" title="Toggle dark/light"><span class="icon">ðŸŒ™</span><span class="label">Light</span></button>
    </div>
  </header>

  <!-- Full-screen Loading -->
  <section class="status" id="statusArea" aria-live="polite">
    <div class="loader"><div class="spinner"></div><div><strong>Processing data</strong><span class="dots"></span></div></div>
  </section>

  <!-- KPIs -->
  <section class="kpis" id="kpiSection" hidden>
    <div class="kpi-card">
      <div class="kpi-top">
        <div class="kpi-label">Spend</div>
        <div class="kpi-right"><div class="kpi-acos-label">ACOS</div><div class="kpi-acos-val" id="kpiACOS">â€”</div></div>
      </div>
      <div class="kpi-value" id="kpiSpend">â€”</div>
      <div class="kpi-sub">Revenue</div>
      <div class="kpi-sub-strong" id="kpiRevenue">â€”</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-top">
        <div class="kpi-label">Total Clicks</div>
        <div class="kpi-right"><div class="kpi-ctr-label">CTR</div><div class="kpi-ctr-val" id="kpiCTR">â€”</div></div>
      </div>
      <div class="kpi-value" id="kpiClicks">â€”</div>
      <div class="kpi-sub">Impressions</div>
      <div id="kpiImpressionsBlack">â€”</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-top"><div class="kpi-label">ROAS</div></div>
      <div class="kpi-value" id="kpiROAS">â€”</div>
      <div class="kpi-sub">Return on Ad Spend</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-top"><div class="kpi-label">Average CPC</div></div>
      <div class="kpi-value" id="kpiAvgCPC">â€”</div>
      <div class="kpi-sub">Cost per Click</div>
    </div>
  </section>

  <!-- Charts -->
  <section class="charts" id="chartsSection" hidden>
    <div class="chart-card" id="barCard">
      <div class="chart-title" id="barTitle">Store â€” Spend, Sales & ACOS</div>
      <div class="chart-body"><div class="nodata">No data to display</div><canvas id="barChart"></canvas></div>
    </div>
    <div class="chart-card" id="pieCard">
      <div class="chart-title" id="pieTitle">Breakdown by Category (Spend)</div>
      <div class="chart-body"><div class="nodata">No data to display</div><canvas id="pieChart"></canvas></div>
    </div>
    <div class="chart-card" id="lineCard" hidden>
      <div class="chart-title" id="lineTitle">ACOS Over Time</div>
      <div class="chart-body"><div class="nodata">No data to display</div><canvas id="lineChart"></canvas></div>
    </div>
  </section>

  <!-- Filters Modal -->
  <div id="filtersModal" class="modal" aria-hidden="true" role="dialog" aria-label="Filters">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Filters</h3>
        <button id="closeFilters" class="ghost" title="Close">âœ•</button>
      </div>

      <section class="filters" id="filtersSection" hidden>
        <div class="filter"><label>Category</label><div id="categoryMS" class="dd"></div></div>
        <div class="filter"><label>LO</label><div id="loMS" class="dd"></div></div>
        <div class="filter"><label>Targeting Type</label><div id="ttypeMS" class="dd"></div></div>
        <div class="filter"><label>Targeting SubType</label><div id="tsubMS" class="dd"></div></div>
        <div class="filter"><label>Targeting SubType2</label><div id="tsub2MS" class="dd"></div></div>
        <div class="filter grow"><label>Campaign Name</label><div id="campaignMS" class="dd"></div></div>
        <div class="filter grow"><label>Portfolio Name</label><div id="portfolioMS" class="dd"></div></div>

        <div class="filter date"><label>Date Range</label>
          <div style="display:flex;gap:6px">
            <input type="text" id="startDate" placeholder="dd-mm-yyyy" inputmode="numeric" style="flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:var(--panel);color:var(--text)" />
            <span class="sep" style="align-self:center;padding:0 6px">â€”</span>
            <input type="text" id="endDate" placeholder="dd-mm-yyyy" inputmode="numeric" style="flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:var(--panel);color:var(--text)" />
          </div>
        </div>

        <div class="filter search"><label for="searchFilter">Search Term</label>
          <input id="searchFilter" type="search" placeholder="Type to filter termsâ€¦" style="flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:var(--panel);color:var(--text)">
        </div>
      </section>

      <div class="modal-actions">
        <button id="clearAll" class="btn-outline">Clear All</button>
        <button id="cancelFilters" class="ghost">Cancel</button>
        <button id="applyFilters" class="btn-primary">Apply</button>
      </div>
    </div>
  </div>

  <script>
  'use strict';

  const MANIFEST_FILE='excel-index.json';
  const PREFERRED_DEFAULT='Products Search Term.xlsx';

  const el={
    status:document.getElementById('statusArea'),
    kpis:document.getElementById('kpiSection'),
    charts:document.getElementById('chartsSection'),
    fileSelect:document.getElementById('fileSelect'),
    pickLocalBtn:document.getElementById('pickLocalBtn'),
    fileInput:document.getElementById('fileInput'),
    dlCsv:document.getElementById('downloadCsvBtn'),
    openFiltersBtn:document.getElementById('openFilters'),
    modal:document.getElementById('filtersModal'),
    closeFiltersBtn:document.getElementById('closeFilters'),
    cancelFiltersBtn:document.getElementById('cancelFilters'),
    applyFiltersBtn:document.getElementById('applyFilters'),
    clearAllBtn:document.getElementById('clearAll'),
    filters:document.getElementById('filtersSection'),
    barCard:document.getElementById('barCard'), pieCard:document.getElementById('pieCard'), lineCard:document.getElementById('lineCard'),
    bar:document.getElementById('barChart'), pie:document.getElementById('pieChart'), line:document.getElementById('lineChart'),
    lineTitle:document.getElementById('lineTitle'), pieTitle:document.getElementById('pieTitle'), barTitle:document.getElementById('barTitle'),
    dd:{
      category:document.getElementById('categoryMS'),
      lo:document.getElementById('loMS'),
      ttype:document.getElementById('ttypeMS'),
      tsub:document.getElementById('tsubMS'),
      tsub2:document.getElementById('tsub2MS'),
      campaign:document.getElementById('campaignMS'),
      portfolio:document.getElementById('portfolioMS')
    },
    start:document.getElementById('startDate'),
    end:document.getElementById('endDate'),
    search:document.getElementById('searchFilter'),
    themeBtn:document.getElementById('themeToggle'),
    kpi:{
      spend:document.getElementById('kpiSpend'),
      acos:document.getElementById('kpiACOS'),
      revenue:document.getElementById('kpiRevenue'),
      clicks:document.getElementById('kpiClicks'),
      ctr:document.getElementById('kpiCTR'),
      impressionsBlack:document.getElementById('kpiImpressionsBlack'),
      roas:document.getElementById('kpiROAS'),
      avgcpc:document.getElementById('kpiAvgCPC')
    }
  };

  const state={ rawHeaders:[], rows:[], columns:{}, charts:{bar:null,pie:null,line:null}, fileName:'', availableFiles:[], fileMap:{}, snapshot:{} };

  const COLKEY = {
    category:'category', lo:'lo', store:'store',
    ttype:'targetingType', tsub:'targetingSubType', tsub2:'targetingSubType2',
    campaign:'campaignName', portfolio:'portfolioName',
    term:'term', impressions:'impressions', clicks:'clicks', ctr:'ctr', revenue:'revenue', spend:'spend', date:'date'
  };
  const colObj = (kind)=> state.columns[COLKEY[kind]];
  const colKey = (kind)=> colObj(kind)? normalizeHeader(colObj(kind).name) : null;

  const SYN={
    term:["search term","customer search term","term","keyword","search keyword","search query","query"],
    impressions:["impressions","searches","volume","search volume","views"],
    clicks:["clicks","click"],
    ctr:["ctr","click-through rate","click through rate","click thru rate"],
    revenue:["7 day total sales","7-day total sales","7 day sales","revenue","sales","gmv","turnover","amount","net sales","ordered revenue","attributed sales"],
    spend:["spend","cost","ad spend","ad cost","total spend","ppc spend","cpc cost"],
    category:["category","product category","cat","product type","taxonomy"],
    date:["date","day","reporting date","calendar date","dt","order date"],
    lo:["lo","l.o.","line of business","locale","market"],
    store:["store","store name","storefront","marketplace","market","country","site"],
    targetingType:["targeting type","type","ad targeting type"],
    targetingSubType:["targeting subtype","targeting sub type","targeting sub-type","sub type","sub-type","subtype","match type","targeting match type"],
    targetingSubType2:["targeting subtype2","targeting sub type2","targeting sub-type2","sub type 2","sub-type 2","subtype2","match type 2"],
    campaignName:["campaign name","campaign"],
    portfolioName:["portfolio name","portfolio"]
  };
  const SUBSTR={
    term:[/term|keyword|query/i],
    impressions:[/impr|search|volume|views?/i],
    clicks:[/click/i],
    ctr:[/ctr|click.?through/i],
    revenue:[/7.?day.*sales|rev(enue)?|sales|gmv|turnover|amount/i],
    spend:[/spend|cost\b/i],
    category:[/categor|product type|taxonomy/i],
    date:[/date|day/i],
    lo:[/^(lo|l\.o\.)$|line of business|locale|market/i],
    store:[/store(front)?|market(place)?|country|site/i],
    targetingType:[/targeting.*type|^type$|ad targeting/i],
    targetingSubType:[/targeting.*sub.?type|sub.?type|match.*type/i],
    targetingSubType2:[/sub.?type\s*2|subtype2|match.*type.*2/i],
    campaignName:[/campaign.*name|^campaign$/i],
    portfolioName:[/portfolio.*name|^portfolio$/i]
  };

  const fmt={
    int:n=>isFinite(n)?n.toLocaleString():"â€”",
    compact:n=>isFinite(n)?new Intl.NumberFormat(undefined,{notation:'compact',maximumFractionDigits:1}).format(n):"â€”",
    pct:r=>isFinite(r)?(r*100).toLocaleString(undefined,{maximumFractionDigits:2})+'%':"â€”",
    money:n=>isFinite(n)?n.toLocaleString(undefined,{style:"currency",currency:"USD"}):"â€”",
    money0:n=>isFinite(n)?n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0,minimumFractionDigits:0}):"â€”"
  };

  const normalizeHeader=h=>String(h||"").trim().toLowerCase().replace(/\s+/g," ");
  const escapeHtml=s=>String(s).replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const toDMY=d=>!(d instanceof Date)?"":`${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
  const parseDMY=(s)=>{ if(!s) return null; const m=String(s).match(/^(\d{2})[-/](\d{2})[-/](\d{4})$/); if(!m) return null; const d=new Date(+m[3], +m[2]-1, +m[1]); return isNaN(+d)?null:d; };

  document.addEventListener('DOMContentLoaded', async () => {
    initTheme();
    wireButtons();
    await autoLoadExcel();
  });

  function initTheme(){
    const saved=localStorage.getItem('theme')||'dark';
    if(saved==='light') document.body.classList.add('light');
    updateThemeBtn();
    el.themeBtn.addEventListener('click',()=>{
      document.body.classList.toggle('light');
      localStorage.setItem('theme', document.body.classList.contains('light')?'light':'dark');
      updateThemeBtn();
      window._renderAll && window._renderAll();
    });
    function updateThemeBtn(){
      const light=document.body.classList.contains('light');
      el.themeBtn.classList.toggle('mode-dark', light);
      el.themeBtn.classList.toggle('mode-light', !light);
      el.themeBtn.querySelector('.icon').textContent= light?'ðŸŒ™':'â˜€ï¸';
      el.themeBtn.querySelector('.label').textContent= light?'Dark':'Light';
    }
  }

  function wireButtons(){
    el.pickLocalBtn.addEventListener('click', ()=> el.fileInput.click());
    el.fileInput.addEventListener('change', handleLocalFile);
    el.dlCsv.addEventListener('click', onDownloadCsv);

    el.openFiltersBtn.addEventListener('click', openFiltersModal);
    el.closeFiltersBtn.addEventListener('click', closeFiltersModalCancel);
    el.cancelFiltersBtn.addEventListener('click', closeFiltersModalCancel);
    el.applyFiltersBtn.addEventListener('click', closeFiltersModalApply);
    el.clearAllBtn.addEventListener('click', ()=>{ clearAllFilters(); });

    document.addEventListener('click', (e)=>{
      const isDD = e.target.closest?.('.dd');
      document.querySelectorAll('.dd.open').forEach(n=>{ if(n!==isDD) n.classList.remove('open'); });
    });
  }

  function showLoading(on){
    document.body.classList.toggle('loading', !!on);
    el.status.classList.toggle('show', !!on);
    el.status.style.display = on ? '' : 'none';
    el.kpis.hidden = true;
    el.charts.hidden = true;
    el.openFiltersBtn.style.display = 'none';
    el.dlCsv.style.display = on ? 'none' : '';
    el.pickLocalBtn.style.display = on ? 'none' : '';
    el.fileSelect.hidden = true;
  }

  async function autoLoadExcel(){
    try{
      showLoading(true);
      const list = await getExcelList();
      setupFilePicker(list);
      const url = new URL(window.location.href);
      const qFile = url.searchParams.get('file');
      const last  = localStorage.getItem('lastExcelFile');
      const preferred = list.includes(PREFERRED_DEFAULT) ? PREFERRED_DEFAULT : null;
      const pick = preferred || qFile || (last && list.includes(last) ? last : null) || (list[0] || null);
      if(!pick) throw new Error('No Excel files found.');
      await tryLoadSpecific(pick);
    }catch(err){
      console.error(err);
      showLoading(false);
      const tip = document.createElement('div');
      tip.style.padding='16px clamp(16px,3vw,32px)';
      tip.style.color='var(--muted)';
      tip.innerHTML='Tip: add an Excel next to this file or click <b>Open XLSX</b>.';
      document.body.insertBefore(tip, document.querySelector('.kpis'));
    }
  }
  async function getExcelList(){
    state.availableFiles = []; state.fileMap = {};
    try{
      const res = await fetch(MANIFEST_FILE, { cache:'no-store' });
      if(res.ok){
        const manifest = await res.json();
        let items = [];
        if(Array.isArray(manifest)) items = manifest;
        else if(Array.isArray(manifest.files)) items = manifest.files;
        if(items.length){
          for(const it of items){
            if(typeof it === 'string' && /\.xlsx$/i.test(it)){ state.availableFiles.push(it.split('/').pop()); state.fileMap[it.split('/').pop()] = it; }
            else if(it && typeof it === 'object' && /\.xlsx$/i.test(it.name)){ state.availableFiles.push(it.name); state.fileMap[it.name] = it.url || it.name; }
          }
        }
      }
    }catch(_){}
    if(state.availableFiles.length) return state.availableFiles;

    const guesses = [PREFERRED_DEFAULT,'search_data.xlsx','SearchTerms.xlsx','data.xlsx'];
    for(const g of guesses){
      try{ const r = await fetch(g,{method:'HEAD',cache:'no-store'}); if(r.ok){ state.availableFiles.push(g); state.fileMap[g]=g; break; } }catch(_){ }
    }
    return state.availableFiles;
  }
  function setupFilePicker(files){
    if(!Array.isArray(files) || files.length<2){ el.fileSelect.hidden=true; return; }
    el.fileSelect.innerHTML = files.map(f=>`<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join('');
    el.fileSelect.hidden=false;
    el.fileSelect.addEventListener('change', async (e)=>{ const name=e.target.value; if(name) await tryLoadSpecific(name); });
  }
  async function tryLoadSpecific(name){
    showLoading(true);
    const url = state.fileMap[name] || name;
    const buf = await (await fetch(url,{cache:'no-store'})).arrayBuffer();
    await tryLoadFromBuffer(buf, name);
  }
  async function handleLocalFile(e){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    showLoading(true);
    const buf = await file.arrayBuffer();
    await tryLoadFromBuffer(buf, file.name);
    e.target.value = '';
  }

  function countNonEmpty(arr){ return (arr||[]).reduce((n,v)=> n + (v!==undefined && v!==null && String(v).trim()!=="") , 0); }
  function parseNumber(v){
    if(v==null) return 0;
    if(typeof v==='number') return isFinite(v)?v:0;
    let s=String(v).trim(); if(!s) return 0;
    if(/^\(.*\)$/.test(s)) s='-'+s.slice(1,-1);
    if(/%$/.test(s)){ const num=parseFloat(s.replace(/[%\s,]/g,'')); return isFinite(num)?num/100:0; }
    s=s.replace(/[$â‚¬Â£â‚¹Â¥â‚©]|[A-Za-z]/g,'').replace(/,/g,'').trim();
    const num=parseFloat(s); return isFinite(num)?num:0;
  }
  function parseMaybeDate(v){
    if(v==null||v==="") return null;
    if(typeof v==='number'){ const o=XLSX.SSF.parse_date_code(v); if(o&&o.y&&o.m&&o.d) return new Date(o.y,o.m-1,o.d); }
    const d=new Date(v); return isNaN(+d)?null:d;
  }
  function findHeaderSmart(headers, exactList, substrRx){
    const L=headers.map(normalizeHeader);
    for(const k of exactList){ const idx=L.indexOf(k); if(idx!==-1) return {idx,i:idx,name:headers[idx]}; }
    for(let i=0;i<L.length;i++){ if(substrRx.some(rx=>rx.test(L[i]))) return {idx:i,i,name:headers[i]}; }
    return null;
  }
  function columnFamilySmart(norm){
    const has=(arr,rx)=> (arr?.includes(norm) || rx?.some(r=>r.test(norm)));
    if (has(SYN.term,SUBSTR.term)) return 'term';
    if (has(SYN.impressions,SUBSTR.impressions)) return 'impressions';
    if (has(SYN.clicks,SUBSTR.clicks)) return 'clicks';
    if (has(SYN.ctr,SUBSTR.ctr)) return 'ctr';
    if (has(SYN.revenue,SUBSTR.revenue)) return 'revenue';
    if (has(SYN.spend,SUBSTR.spend)) return 'spend';
    if (has(SYN.category,SUBSTR.category)) return 'category';
    if (has(SYN.date,SUBSTR.date)) return 'date';
    if (has(SYN.lo,SUBSTR.lo)) return 'lo';
    if (has(SYN.store,SUBSTR.store)) return 'store';
    if (has(SYN.targetingType,SUBSTR.targetingType)) return 'targetingType';
    if (has(SYN.targetingSubType,SUBSTR.targetingSubType)) return 'targetingSubType';
    if (has(SYN.targetingSubType2,SUBSTR.targetingSubType2)) return 'targetingSubType2';
    if (has(SYN.campaignName,SUBSTR.campaignName)) return 'campaignName';
    if (has(SYN.portfolioName,SUBSTR.portfolioName)) return 'portfolioName';
    return 'other';
  }

  async function tryLoadFromBuffer(buf, fileName){
    const wb  = XLSX.read(buf, { type:'array', cellDates:true, cellNF:true, cellText:false });
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];

    const raw  = XLSX.utils.sheet_to_json(ws, { header:1, raw:true,  defval:"" });
    const text = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:"" });
    const aoa  = raw.map((row,r)=> row.map((v,c)=> (v===""||v==null) ? (text[r]?.[c] ?? "") : v));
    if(aoa.length < 2) throw new Error('Sheet is empty or lacks enough rows');

    let headerRowIndex = 1;
    if (countNonEmpty(aoa[1]) < 2){
      for(let i=0;i<Math.min(10,aoa.length);i++){
        if (countNonEmpty(aoa[i]) >= 2){ headerRowIndex=i; break; }
      }
    }

    const headers = (aoa[headerRowIndex]||[]).map(h => String(h||"").trim());
    state.rawHeaders = headers.slice();
    const dataRows = aoa.slice(headerRowIndex+1);

    const rows=[];
    for(const row of dataRows){
      if(!row || row.every(v=>v==null || String(v).trim()==="")) continue;
      const obj={};
      headers.forEach((h,idx)=>{
        const norm=normalizeHeader(h);
        let val=row[idx];
        const fam=columnFamilySmart(norm);
        if (fam==='date')      val=parseMaybeDate(val);
        else if (['impressions','clicks','ctr','revenue','spend'].includes(fam)) val=parseNumber(val);
        obj[h]=val; obj[norm]=val;
      });
      rows.push(obj);
    }
    state.rows = rows;

    state.columns = {
      term:        findHeaderSmart(headers, SYN.term, SUBSTR.term),
      impressions: findHeaderSmart(headers, SYN.impressions, SUBSTR.impressions),
      clicks:      findHeaderSmart(headers, SYN.clicks, SUBSTR.clicks),
      ctr:         findHeaderSmart(headers, SYN.ctr, SUBSTR.ctr),
      revenue:     findHeaderSmart(headers, SYN.revenue, SUBSTR.revenue),
      spend:       findHeaderSmart(headers, SYN.spend, SUBSTR.spend),
      category:    findHeaderSmart(headers, SYN.category, SUBSTR.category),
      date:        findHeaderSmart(headers, SYN.date, SUBSTR.date),
      lo:          findHeaderSmart(headers, SYN.lo, SUBSTR.lo),
      store:       findHeaderSmart(headers, SYN.store, SUBSTR.store),
      targetingType:     findHeaderSmart(headers, SYN.targetingType, SUBSTR.targetingType),
      targetingSubType:  findHeaderSmart(headers, SYN.targetingSubType, SUBSTR.targetingSubType),
      targetingSubType2: findHeaderSmart(headers, SYN.targetingSubType2, SUBSTR.targetingSubType2),
      campaignName:      findHeaderSmart(headers, SYN.campaignName, SUBSTR.campaignName),
      portfolioName:     findHeaderSmart(headers, SYN.portfolioName, SUBSTR.portfolioName),
    };

    state.fileName = String(fileName||'');
    if(state.fileName) localStorage.setItem('lastExcelFile', state.fileName);
    if(!el.fileSelect.hidden && state.fileName && state.availableFiles?.includes?.(state.fileName)){ el.fileSelect.value = state.fileName; }

    initFilters();
    enableUI(true);
    _renderAll();

    showLoading(false);
    if(state.rows.length) el.openFiltersBtn.style.display = 'inline-flex';
  }

  /* ========================= Dropdown Multi (unchanged core) ========================= */
  function ddBuild(root){
    root.innerHTML = `
      <div class="dd-control"><span class="dd-summary">All</span><span class="dd-chev">â–¾</span></div>
      <div class="dd-panel">
        <div class="dd-head">
          <label class="select-all"><input type="checkbox" class="dd-select-all"/><span>Select All</span></label>
          <input type="search" class="dd-search" placeholder="Type to search"/>
          <div class="rc">Record Count</div>
        </div>
        <div class="dd-list"></div>
      </div>
    `;
    root.querySelector('.dd-control').addEventListener('click', ()=>{
      const wasOpen = root.classList.contains('open');
      document.querySelectorAll('.dd.open').forEach(n=>n.classList.remove('open'));
      root.classList.toggle('open', !wasOpen);
      if(!wasOpen){
        requestAnimationFrame(()=>{
          const panel = root.querySelector('.dd-panel');
          root.classList.remove('align-right');
          const modal = root.closest('.modal-card');
          const rect = panel.getBoundingClientRect();
          const container = modal ? modal.getBoundingClientRect() : {right:window.innerWidth,left:0};
          const margin = 16;
          if(rect.right > container.right - margin){ root.classList.add('align-right'); }
          if(root.querySelector('.dd-search')){
            root.querySelector('.dd-search').value = root.dataset.q || '';
            ddApplySearchFilter(root);
            root.querySelector('.dd-search').focus();
          }
        });
      }
    });
    root.querySelector('.dd-panel').addEventListener('click', (e)=> e.stopPropagation());

    root.querySelector('.dd-select-all').addEventListener('change', (e)=>{
      const on = e.target.checked;
      root.querySelectorAll('.dd-item:not([hidden]) input[type=checkbox]').forEach(cb=>cb.checked = on);
      ddUpdateSummary(root); ddSyncSelectAll(root);
      updateAllFilterOptions();
    });

    const searchEl = root.querySelector('.dd-search');
    const onSearch = ()=>{
      root.dataset.q = searchEl.value;
      ddApplySearchFilter(root);
    };
    searchEl.addEventListener('input', onSearch);
    searchEl.addEventListener('keyup', onSearch);
  }
  function ddApplySearchFilter(root){
    const q = (root.querySelector('.dd-search')?.value || '').trim().toLowerCase();
    root.querySelectorAll('.dd-item').forEach(item=>{
      const txt = item.querySelector('.dd-text').textContent.toLowerCase();
      item.hidden = q && !txt.includes(q);
    });
    ddSyncSelectAll(root);
  }
  function ddSetOptions(root, items, keepSel=true){
    if(!root.querySelector('.dd-panel')) ddBuild(root);
    const list = root.querySelector('.dd-list');
    const prevSel = keepSel ? new Set(ddGetSelected(root)) : new Set();
    list.innerHTML = items.map(({v,count})=>`
      <div class="dd-item" title="${escapeHtml(v)}">
        <label class="dd-left">
          <input type="checkbox" value="${escapeHtml(v)}" ${prevSel.has(String(v))?'checked':''}/>
          <span class="dd-text">${escapeHtml(v)}</span>
        </label>
        <button type="button" class="dd-only" data-val="${escapeHtml(v)}">ONLY</button>
        <div class="dd-count">${(count??0).toLocaleString()}</div>
      </div>
    `).join('');
    list.querySelectorAll('.dd-only').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const val = btn.getAttribute('data-val');
        ddOnly(root, val);
        root.classList.remove('open');
        updateAllFilterOptions();
      });
    });
    list.querySelectorAll('input[type=checkbox]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        ddUpdateSummary(root); ddSyncSelectAll(root);
        updateAllFilterOptions();
      });
    });
    ddUpdateSummary(root); ddSyncSelectAll(root);
    if(root.dataset.q){ const s=root.querySelector('.dd-search'); if(s){ s.value=root.dataset.q; } }
    ddApplySearchFilter(root);
  }
  function ddGetSelected(root){
    return Array.from(root.querySelectorAll('.dd-list input[type=checkbox]:checked')).map(cb=>cb.value);
  }
  function ddClear(root){
    root.querySelectorAll('.dd-list input[type=checkbox]').forEach(cb=>cb.checked=false);
    root.dataset.q = '';
    const s=root.querySelector('.dd-search'); if(s) s.value='';
    ddUpdateSummary(root); ddSyncSelectAll(root);
  }
  function ddOnly(root, value){
    root.querySelectorAll('.dd-list input[type=checkbox]').forEach(cb=>cb.checked = (cb.value===value));
    ddUpdateSummary(root); ddSyncSelectAll(root);
  }
  function ddUpdateSummary(root){
    const sel = ddGetSelected(root);
    const summary = root.querySelector('.dd-summary');
    if(sel.length===0) summary.textContent='All';
    else if(sel.length===1) summary.textContent=sel[0];
    else summary.textContent=`${sel.length} selected`;
  }
  function ddSyncSelectAll(root){
    const vis = Array.from(root.querySelectorAll('.dd-item:not([hidden]) input[type=checkbox]'));
    const all = vis.length && vis.every(cb=>cb.checked);
    const sa = root.querySelector('.dd-select-all');
    if(sa) sa.checked = !!all;
  }

  /* ============================== Filters ============================== */
  function initFilters(){
    Object.values(el.dd).forEach(ddBuild);
    buildOptionsAll();

    const dKey = colKey('date');
    if (dKey){
      const dates = state.rows.map(r => r[dKey]).filter(Boolean).sort((a,b)=>a-b);
      el.start.value = dates[0] ? toDMY(dates[0]) : '';
      el.end.value   = dates[dates.length-1] ? toDMY(dates[dates.length-1]) : '';
    } else { el.start.value=''; el.end.value=''; }

    [el.start, el.end].forEach(n => n.addEventListener('input', ()=>{
      const fix=v=>{const d=parseDMY(v); return d?toDMY(d):v;};
      n.value=fix(n.value);
      updateAllFilterOptions();
    }));

    el.search.addEventListener('input', ()=> updateAllFilterOptions());

    el.filters.hidden=false;
  }

  function buildOptionsAll(){
    Object.entries(el.dd).forEach(([k,root])=>{
      if(!colObj(k)) return;
      const values = uniqValues(k);
      const items = values.map(v=>({v,count:0}));
      ddSetOptions(root, items, false);
    });
    updateAllFilterOptions();
  }

  function uniqValues(kind){
    const key = colKey(kind);
    if(!key) return [];
    const set = new Set();
    state.rows.forEach(r => { const v = r[key]; if (v==null || v==="") return; set.add(String(v)); });
    return Array.from(set).sort((a,b)=> String(a).localeCompare(String(b)));
  }

  function optionsWithCounts(kind, rows){
    const key = colKey(kind);
    if(!key) return [];
    const map = new Map();
    rows.forEach(r=>{ const v = r[key]; if(v==null || v==="") return; map.set(String(v), (map.get(String(v))||0)+1); });
    const root = el.dd[kind];
    const selected = new Set(ddGetSelected(root));
    selected.forEach(v=>{ if(!map.has(v)) map.set(v,0); });
    return [...map.entries()].sort((a,b)=> b[1]-a[1] || String(a[0]).localeCompare(String(b[0])) )
            .map(([v,count])=>({v,count}));
  }

  function activeSelections(excludeRoot){
    const act = {};
    Object.entries(el.dd).forEach(([key,root])=>{
      if(!colObj(key)) return;
      if(excludeRoot && root===excludeRoot) return;
      const vals = ddGetSelected(root);
      if(vals.length) act[colKey(key)] = new Set(vals.map(String));
    });
    const dateKey = colKey('date');
    const from = dateKey && parseDMY(el.start.value);
    const to   = dateKey && parseDMY(el.end.value); if(to) to.setHours(23,59,59,999);
    return { act, dateKey, from, to, termKey: colKey('term') };
  }
  function rowsForFilterContext(excludeRoot){
    const {act, dateKey, from, to, termKey} = activeSelections(excludeRoot);
    const needle = el.search.value.trim().toLowerCase();
    return state.rows.filter(r=>{
      if (needle && termKey){ const t=(r[termKey]??'').toString().toLowerCase(); if(!t.includes(needle)) return false; }
      if (dateKey && (from||to)){
        const d=r[dateKey]; if(!(d instanceof Date)) return false;
        if (from && d<from) return false; if (to && d>to) return false;
      }
      for(const colKeyName in act){
        const set = act[colKeyName];
        if(!set.has(String(r[colKeyName]))) return false;
      }
      return true;
    });
  }

  function updateAllFilterOptions(){
    Object.entries(el.dd).forEach(([key,root])=>{
      if(!colObj(key)) return;
      const baseRows = rowsForFilterContext(root);
      const items = optionsWithCounts(key, baseRows);
      ddSetOptions(root, items, true);
    });
  }

  function snapshotFilters(){
    state.snapshot = {
      category:ddGetSelected(el.dd.category),
      lo:ddGetSelected(el.dd.lo),
      ttype:ddGetSelected(el.dd.ttype),
      tsub:ddGetSelected(el.dd.tsub),
      tsub2:ddGetSelected(el.dd.tsub2),
      campaign:ddGetSelected(el.dd.campaign),
      portfolio:ddGetSelected(el.dd.portfolio),
      start:el.start.value, end:el.end.value, search:el.search.value
    };
  }
  function restoreSnapshot(){
    const s=state.snapshot||{};
    const setVals=(root, vals=[])=>{
      root.querySelectorAll('.dd-list input[type=checkbox]').forEach(cb=>cb.checked = vals.includes(cb.value));
      root.dataset.q='';
      const se=root.querySelector('.dd-search'); if(se) se.value='';
      ddUpdateSummary(root); ddSyncSelectAll(root); ddApplySearchFilter(root);
    };
    setVals(el.dd.category, s.category||[]);
    setVals(el.dd.lo, s.lo||[]);
    setVals(el.dd.ttype, s.ttype||[]);
    setVals(el.dd.tsub, s.tsub||[]);
    setVals(el.dd.tsub2, s.tsub2||[]);
    setVals(el.dd.campaign, s.campaign||[]);
    setVals(el.dd.portfolio, s.portfolio||[]);
    el.start.value=s.start??''; el.end.value=s.end??''; el.search.value=s.search??'';
    updateAllFilterOptions();
  }
  function openFiltersModal(){
    snapshotFilters();
    el.modal.classList.add('open'); el.modal.setAttribute('aria-hidden','false');
  }
  function closeFiltersModalCancel(){
    restoreSnapshot();
    el.modal.classList.remove('open'); el.modal.setAttribute('aria-hidden','true');
    document.querySelectorAll('.dd.open').forEach(n=>n.classList.remove('open'));
  }
  function closeFiltersModalApply(){
    el.modal.classList.remove('open'); el.modal.setAttribute('aria-hidden','true');
    document.querySelectorAll('.dd.open').forEach(n=>n.classList.remove('open'));
    _renderAll();
  }
  function clearAllFilters(){
    Object.values(el.dd).forEach(root=> ddClear(root));
    el.start.value=''; el.end.value=''; el.search.value='';
    updateAllFilterOptions();
    _renderAll();
  }

  function getFilteredRows(){
    const {act, dateKey, from, to, termKey} = activeSelections(null);
    const needle = el.search.value.trim().toLowerCase();
    return state.rows.filter(r=>{
      if (needle && termKey){ const t=(r[termKey]??'').toString().toLowerCase(); if(!t.includes(needle)) return false; }
      if (dateKey && (from||to)){
        const d=r[dateKey]; if(!(d instanceof Date)) return false;
        if (from && d<from) return false; if (to && d>to) return false;
      }
      for(const colKeyName in act){
        const set = act[colKeyName];
        if(!set.has(String(r[colKeyName]))) return false;
      }
      return true;
    });
  }

  /* ================================ KPIs ============================== */
  function computeKPIs(rows){
    const k={ imp:colKey('impressions'), clk:colKey('clicks'), rev:colKey('revenue'), spend:colKey('spend') };
    let impT=0, clkT=0, revT=0, spendT=0;
    for(const r of rows){ impT+=(+r[k.imp]||0); clkT+=(+r[k.clk]||0); revT+=(+r[k.rev]||0); spendT+=(+r[k.spend]||0); }
    const ctr = impT>0 ? clkT/impT : NaN;
    const acos = revT>0 ? spendT/revT : NaN;
    const roas = spendT>0 ? revT/spendT : NaN;
    const avgcpc = clkT>0 ? spendT/clkT : NaN;
    return { impT, clkT, revT, spendT, ctr, acos, roas, avgcpc };
  }
  function renderKPIs(x){
    el.kpi.spend.textContent   = fmt.money0(x.spendT);
    el.kpi.revenue.textContent = fmt.money0(x.revT);
    el.kpi.acos.textContent    = isFinite(x.acos) ? Math.round(x.acos*100)+'%' : 'â€”';
    el.kpi.clicks.textContent  = fmt.int(x.clkT);
    el.kpi.ctr.textContent     = isFinite(x.ctr) ? (x.ctr*100).toFixed(2)+'%' : 'â€”';
    el.kpi.impressionsBlack.textContent = fmt.int(x.impT);
    el.kpi.roas.textContent    = isFinite(x.roas) ? x.roas.toFixed(2)+'x' : 'â€”';
    el.kpi.avgcpc.textContent  = isFinite(x.avgcpc) ? fmt.money(x.avgcpc) : 'â€”';
  }

  /* ================================ Charts ================================ */
  function setNoData(cardEl, hasData){
    const nd=cardEl.querySelector('.nodata'); if(!nd) return;
    nd.style.display = hasData ? 'none':'grid'; nd.hidden = hasData;
  }
  function chartColors(n){ const light=document.body.classList.contains('light'); const L=light?55:65; return Array.from({length:n},(_,i)=>`hsl(${Math.round((360/n)*i)},70%,${L}%)`); }
  function pureColors(n){ const base=['#E74C3C','#3498DB','#2ECC71','#F1C40F','#9B59B6','#E67E22','#1ABC9C','#E91E63','#34495E','#95A5A6','#D35400','#27AE60']; return Array.from({length:n},(_,i)=> base[i % base.length]); }

  // Point labels for ACOS dots (0 decimals)
  const pointPctLabels = {
    id:'pointPctLabels',
    afterDatasetsDraw(chart){
      const dsIndex = chart.data.datasets.findIndex(ds=>ds._isAcos);
      if(dsIndex===-1) return;
      const meta = chart.getDatasetMeta(dsIndex);
      const ds = chart.data.datasets[dsIndex];
      const {ctx} = chart; ctx.save();
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text').trim() || '#fff';
      ctx.font = '12px system-ui,-apple-system, Segoe UI, Roboto, Arial';
      meta.data.forEach((pt,i)=>{
        const val = ds.data[i];
        if(val==null) return;
        const p = pt.getProps(['x','y'], true);
        ctx.textAlign='center'; ctx.textBaseline='bottom';
        ctx.fillText(Math.round(val*100)+'%', p.x, p.y - 4);
      });
      ctx.restore();
    }
  };

  Chart.register(pointPctLabels);

  function renderBar(rows){
    // Choose grouping: Store > LO > Category > Campaign
    let gKey = colKey('store'), gLabel='Store';
    if(!gKey){ gKey = colKey('lo'); gLabel='LO'; }
    if(!gKey){ gKey = colKey('category'); gLabel='Category'; }
    if(!gKey){ gKey = colKey('campaign'); gLabel='Campaign'; }
    el.barTitle.textContent = `${gLabel} â€” Spend, Sales & ACOS`;

    const spendKey = colKey('spend');
    const salesKey = colKey('revenue');
    if(!gKey || !spendKey || !salesKey){ setNoData(el.barCard,false); return; }

    // Aggregate
    const map = new Map();
    for(const r of rows){
      const g = String(r[gKey] ?? '(Unspecified)');
      const sp = +r[spendKey] || 0;
      const sl = +r[salesKey] || 0;
      const prev = map.get(g) || {sp:0, sl:0};
      prev.sp += sp; prev.sl += sl;
      map.set(g, prev);
    }
    // Sort by Sales desc; limit top 12
    const entries = [...map.entries()].sort((a,b)=> (b[1].sl - a[1].sl) || a[0].localeCompare(b[0])).slice(0,12);

    const labels = entries.map(e=>e[0]);
    const spend  = entries.map(e=>e[1].sp);
    const sales  = entries.map(e=>e[1].sl);
    const acos   = entries.map((e)=> e[1].sl>0 ? e[1].sp/e[1].sl : 0);

    const hasData = labels.length>0 && (spend.some(v=>v>0) || sales.some(v=>v>0));
    setNoData(el.barCard, hasData);
    if(state.charts.bar) state.charts.bar.destroy();

    const cols = pureColors(2);
    const dot = '#E74C3C';

    state.charts.bar = new Chart(el.bar.getContext('2d'), {
      type:'bar',
      data:{
        labels,
        datasets:[
          { label:'Spend', data:spend, backgroundColor:cols[0], borderWidth:0, yAxisID:'y' },
          { label:'Sales (7-Day)', data:sales, backgroundColor:cols[1], borderWidth:0, yAxisID:'y' },
          { label:'ACOS %', data:acos, type:'line', yAxisID:'y2', _isAcos:true,
            borderWidth:0, pointRadius:4, pointHoverRadius:5, pointBackgroundColor:dot, pointBorderColor:dot,
            showLine:false }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false, layout:{ padding:8 },
        plugins:{
          legend:{ display:true, position:'top' },
          tooltip:{ callbacks:{
            label:(ctx)=>{
              if(ctx.dataset._isAcos) return ` ${Math.round(ctx.raw*100)}% ACOS`;
              return ` ${ctx.dataset.label}: ${fmt.money0(ctx.raw)}`;
            }
          } }
        },
        scales:{
          x:{ grid:{ display:false } },
          y:{ position:'left', beginAtZero:true, ticks:{ callback:(v)=>fmt.compact(v) } },
          y2:{ position:'right', beginAtZero:true, grid:{ display:false }, ticks:{ callback:(v)=>(v*100).toFixed(0)+'%' } }
        }
      }
    });
  }

  function renderPie(rows){
    const spendKey = colKey('spend');
    let keyName = colKey('category') || colKey('term');
    el.pieTitle.textContent = colKey('category') ? 'Breakdown by Category (Spend)' : 'Breakdown by Top Terms (Spend)';

    const map=new Map();
    for(const r of rows){
      const key=String(r[keyName] ?? '(Unspecified)');
      const v=spendKey?(+r[spendKey]||0):0;
      map.set(key,(map.get(key)||0)+v);
    }
    let pairs=[...map.entries()].filter(p=>p[1]>0).sort((a,b)=>b[1]-a[1]);
    const MAX_SLICES=10; if(pairs.length>MAX_SLICES){ const top=pairs.slice(0,MAX_SLICES); const other=pairs.slice(MAX_SLICES).reduce((s,p)=>s+p[1],0); if(other>0) pairs=[...top,['Other',other]]; else pairs=top; }
    const labels=pairs.map(p=>p[0]); const data=pairs.map(p=>p[1]);
    const hasData = labels.length>0 && data.some(v=>v>0);
    setNoData(el.pieCard, hasData);
    if(state.charts.pie) state.charts.pie.destroy();

    state.charts.pie = new Chart(el.pie.getContext('2d'), {
      type:'doughnut',
      data:{ labels, datasets:[{
        data,
        backgroundColor:pureColors(labels.length),
        borderColor: (document.body.classList.contains('light')?'#fff':'#161b22'),
        borderWidth:2, hoverOffset:6, cutout:'45%'
      }] },
      options:{
        responsive:true, maintainAspectRatio:false, layout:{ padding:8 },
        plugins:{
          legend:{ display: true, position:'right', labels:{ usePointStyle:true, boxWidth:10, boxHeight:10, padding:10, font:{ size:11 } } },
          tooltip:{ enabled:true, callbacks:{
            title:(ctx)=> ctx[0]?.label ?? '',
            label:(ctx)=>{ const val=ctx.parsed; const ds=ctx.dataset?.data||[]; const tot=ds.reduce((a,b)=>a+(+b||0),0); const pct=tot? (val/tot*100):0; return ` ${fmt.money0(val)} (${pct.toFixed(1)}%)`; }
          } }
        }
      }
    });
  }

  function renderLine(rows){
    if(!colObj('date')){ el.lineCard.hidden=true; if(state.charts.line){ state.charts.line.destroy(); state.charts.line=null; } return; }
    el.lineCard.hidden=false;
    el.lineTitle.textContent = 'ACOS Over Time';

    const dateKey=colKey('date');
    const spendKey = colKey('spend');
    const revKey   = colKey('revenue');

    const map=new Map();
    for(const r of rows){
      const d=r[dateKey]; const iso = d instanceof Date ? toDMY(d) : ''; if(!iso) continue;
      const sp=spendKey?(+r[spendKey]||0):0;
      const rv=revKey?(+r[revKey]||0):0;
      const prev=map.get(iso)||{sp:0,rv:0}; prev.sp+=sp; prev.rv+=rv; map.set(iso,prev);
    }
    const series=[...map.entries()].sort((a,b)=>{ const p=a[0].split('-').reverse().join(''); const q=b[0].split('-').reverse().join(''); return p.localeCompare(q); });
    const labels=series.map(s=>s[0]);
    const acosData=series.map(s => s[1].rv>0 ? s[1].sp/s[1].rv : 0);

    const hasData = labels.length>0; setNoData(el.lineCard, hasData);
    if(state.charts.line) state.charts.line.destroy();

    const months = labels.map(l => l.slice(3));
    const uniq=[]; const monthIndex = months.map(m=>{ let i=uniq.indexOf(m); if(i===-1){ i=uniq.push(m)-1; } return i; });
    const pal = chartColors(8); const colorFor = i=> pal[i % pal.length];
    const pointColors = monthIndex.map(i=>colorFor(i));

    state.charts.line = new Chart(el.line.getContext('2d'), {
      type:'line',
      data:{ labels, datasets:[{
        label:'ACOS', data:acosData, fill:false, tension:.2,
        pointRadius:2, pointHoverRadius:3, pointBackgroundColor: pointColors, pointBorderColor: pointColors, borderWidth:2,
        segment:{ borderColor: ctx => colorFor(monthIndex[ctx.p1DataIndex]||0) }
      }] },
      options:{
        responsive:true, maintainAspectRatio:false, layout:{ padding:8 },
        interaction:{ mode:'index', axis:'x', intersect:false },
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{
          title:(items)=> items.length? items[0].label : '',
          label:x=>' '+(x.parsed.y*100).toFixed(2)+'% ACOS'
        } } },
        scales:{ x:{ ticks:{ display:false }, grid:{ display:false } }, y:{ ticks:{ callback:v=>(v*100).toFixed(0)+'%' }, suggestedMin:0 } }
      }
    });
  }

  function enableUI(ready){
    el.kpis.hidden=!ready;
    el.charts.hidden=!ready;
    el.dlCsv.disabled=!ready;
    el.openFiltersBtn.style.display = ready ? 'inline-flex' : 'none';
  }
  function _renderAll(){
    const filtered = getFilteredRows();
    const k = computeKPIs(filtered);
    renderKPIs(k);
    renderBar(filtered);
    renderPie(filtered);
    renderLine(filtered);
  }
  window._renderAll=_renderAll;

  function onDownloadCsv(){
    const rows = getFilteredRows();
    if (!rows.length){ alert('No rows to download for current filters.'); return; }
    const headers = state.rawHeaders.slice();
    const out = rows.map(r=>{ const o={}; headers.forEach(h=>o[h]=r[h]); return o; });
    const csv = toCSV(headers, out);
    const base = state.fileName? state.fileName.replace(/\.[^.]+$/,'') : 'search_data';
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    saveAs(blob, base+'-filtered.csv');
  }
  function toCSV(headers, rows){
    const esc=v=>{ if(v==null) return ''; const s=String(v); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; };
    const head=headers.map(esc).join(',')+'\n';
    const body=rows.map(r=>headers.map(h=>esc(r[h])).join(',')).join('\n');
    return head+body;
  }
  </script>
</body>
</html>
